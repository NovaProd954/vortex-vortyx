<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Vortyx Typhoon Tracker â€“ TY UWAN</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  
  <script src="https://cdn.maptiler.com/maptiler-sdk-js/v2.0.3/maptiler-sdk.umd.min.js"></script>
  <link href="https://cdn.maptiler.com/maptiler-sdk-js/v2.0.3/maptiler-sdk.css" rel="stylesheet" />
  <script src="https://cdn.maptiler.com/maptiler-weather/v2.0.0/maptiler-weather.umd.min.js"></script>
  
  <script src='https://npmcdn.com/@turf/turf/turf.min.js'></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Unbounded:wght@400;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <style>
    /* -------------------------------------- */
    /* THEME VARIABLES (White/Light Theme)    */
    /* -------------------------------------- */
    :root {
        --bg-color: #f8f9fa;               /* Light Grey Background */
        --glass-bg: rgba(255, 255, 255, 0.9); /* White Glass */
        --glass-border: 1px solid rgba(0, 0, 0, 0.08); /* Subtle border */
        --accent-blue: #2563eb;            /* Stronger Blue for contrast */
        --accent-hover: #1d4ed8;
        --text-main: #1f2937;              /* Dark Grey for primary text */
        --text-muted: #6b7280;             /* Medium Grey for secondary */
        --font-stack: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        --font-display: 'Unbounded', sans-serif; /* For Logo */
        --shadow-elevation: 0 4px 20px rgba(0, 0, 0, 0.08);
    }

    /* -------------------------------------- */
    /* CORE LAYOUT                            */
    /* -------------------------------------- */
    html, body { 
        height: 100%; margin: 0; padding: 0; 
        background-color: var(--bg-color); 
        color: var(--text-main);
        font-family: var(--font-stack);
        overflow: hidden;
        -webkit-font-smoothing: antialiased;
    }

    #map { position:absolute; inset: 0; width:100%; height: 100%; z-index: 0; }

    /* -------------------------------------- */
    /* UI COMPONENTS                          */
    /* -------------------------------------- */
    
    /* Header */
    #app-header {
        position: absolute; top: 20px; left: 20px; z-index: 100;
        display: flex; align-items: center; gap: 12px;
        pointer-events: none;
        /* Add a backing for readability over map if needed, or rely on text shadow */
        filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1)); 
    }
    #app-logo-svg {
        width: 38px; height: 38px;
    }
    #app-name {
        font-family: var(--font-display); /* Unbounded Font applied here */
        font-size: 22px; 
        font-weight: 700; 
        letter-spacing: -0.5px;
        color: #111; /* Very dark grey almost black */
        text-shadow: 2px 2px 0px #fff; /* White outline effect for readability */
    }

    /* Glass Panels (Shared Style) */
    .glass-panel {
        background: var(--glass-bg);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: var(--glass-border);
        box-shadow: var(--shadow-elevation);
        border-radius: 16px;
        pointer-events: auto;
    }

    /* Left Menu */
    #menu-panel {
        position: absolute; top: 80px; left: 20px; z-index: 100;
        width: 190px; padding: 10px;
        display: flex; flex-direction: column; gap: 12px;
    }
    .menu-section-title {
        font-size: 11px; text-transform: uppercase; letter-spacing: 1.0px;
        color: var(--text-muted); font-weight: 700; margin: 4px 0 4px 8px;
    }
    .menu-item {
        display: flex; align-items: center; gap: 10px;
        padding: 10px 12px; border-radius: 10px;
        cursor: pointer; transition: all 0.2s ease;
        font-size: 13px; font-weight: 600; color: var(--text-main);
    }
    .menu-item:hover { background: rgba(0,0,0,0.05); color: #000; }
    .menu-item.active { 
        background: var(--accent-blue); 
        color: #fff; 
        box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
    }
    /* SVG Fill fix for active state */
    .menu-item .menu-item-icon { width: 18px; height: 18px; fill: currentColor; }
    
    /* Top Right Info Panel */
    #info-panel {
        position: absolute; top: 20px; right: 20px; z-index: 100;
        width: 250px; padding: 20px;
        border-left: 4px solid #f59e0b; /* Warning Orange */
        background: white; /* Solid white for better readability */
    }
    #info-panel h3 { margin: 0 0 4px 0; font-size: 16px; font-weight: 800; color: #111; letter-spacing: -0.5px; font-family: var(--font-display); }
    .issued-text { font-size: 11px; color: var(--text-muted); margin-top: 2px; }
    .issued-text span { color: #111; font-weight: 700; }

    /* Legends */
    #legend-container-icons {
        position: absolute; top: 140px; right: 20px; z-index: 99;
        width: 220px; padding: 16px;
    }
    .legend-row { display: flex; align-items: center; gap: 10px; font-size: 12px; margin-bottom: 8px; color: var(--text-main); font-weight: 500; }
    
    #legend-container-weather {
        position: absolute; bottom: 100px; right: 20px; z-index: 99;
        width: 220px; padding: 16px; display: none;
    }
    .legend-title { font-size: 12px; font-weight: 700; margin-bottom: 6px; color: var(--text-main); }
    .legend-bar { height: 8px; width: 100%; border-radius: 4px; margin: 8px 0; border: 1px solid rgba(0,0,0,0.1); }
    .legend-labels { display: flex; justify-content: space-between; font-size: 10px; color: var(--text-muted); font-weight: 600; }

    /* Animation Controls */
    #animation-controls {
        position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 100;
        display: flex; align-items: center; gap: 15px; padding: 10px 24px;
        border-radius: 30px;
        background: white; /* Solid white for controls */
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    }
    .anim-btn {
        background: none; border: none; color: var(--text-main); cursor: pointer;
        padding: 8px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
        transition: transform 0.1s, background 0.2s;
    }
    .anim-btn:hover { background: #f3f4f6; color: var(--accent-blue); }
    .anim-btn:active { transform: scale(0.9); }
    .anim-btn.play-pause svg { width: 32px; height: 32px; fill: currentColor; }
    #animation-time { 
        font-family: 'SF Mono', 'Menlo', monospace; 
        font-size: 14px; font-weight: 600; 
        color: var(--accent-blue); 
        min-width: 130px; text-align: center;
        border-left: 1px solid #e5e7eb;
        border-right: 1px solid #e5e7eb;
        padding: 0 16px;
    }

    /* Map Popups (Light Mode) */
    .mapboxgl-popup-content {
        background: #ffffff;
        color: #1f2937;
        border: 1px solid rgba(0,0,0,0.1);
        border-radius: 12px;
        padding: 14px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        font-family: var(--font-stack);
        min-width: 180px;
    }
    .mapboxgl-popup-tip { border-bottom-color: #ffffff !important; }
    .popup-title { color: #f59e0b; font-weight: 800; margin-bottom: 6px; font-size: 13px; border-bottom: 1px solid #eee; padding-bottom: 6px; font-family: var(--font-display); }
    .popup-line { font-size: 12px; margin-bottom: 4px; color: #6b7280; }
    .popup-line strong { color: #111; }

  </style>
</head>
<body>

<div id="map"></div>

<div id="app-header">
    <div id="app-logo-svg">
        <svg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
            <defs>
                <linearGradient id="bgGrad" x1="0" y1="0" x2="1" y2="1">
                    <stop offset="0%" stop-color="#2563eb"/>
                    <stop offset="100%" stop-color="#1e40af"/>
                </linearGradient>
            </defs>
            <rect x="0" y="0" width="200" height="200" rx="40" ry="40" fill="url(#bgGrad)"/>
            <path d="M50,60 C95,170, 105,170, 150,60 L135,60 C100,130, 90,130, 65,60 Z" fill="none" stroke="white" stroke-width="12" stroke-linecap="round" stroke-linejoin="round" stroke-dasharray="600" stroke-dashoffset="600">
                <animate attributeName="stroke-dashoffset" from="600" to="0" dur="2s" repeatCount="indefinite"/>
            </path>
        </svg>
    </div>
    <span id="app-name">VORTYX</span>
</div>

<div id="menu-panel" class="glass-panel">
    
    <div class="menu-section">
        <div class="menu-section-title">Base Maps</div>
        <div class="menu-item active" data-style="STREETS"> <svg class="menu-item-icon" viewBox="0 0 24 24"><path d="M3 11h8V3H3v8zm2-6h4v4H5V5zm8-2v8h8V3h-8zm6 6h-4V5h4v4zM3 21h8v-8H3v8zm2-6h4v4H5v-4zm8 2v4h8v-4h-8z"/></svg>
            Light
        </div>
        <div class="menu-item" data-style="SATELLITE">
            <svg class="menu-item-icon" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm4-10h-2V7h-4v3H8l4 4 4-4z"/></svg>
            Satellite
        </div>
        <div class="menu-item" data-style="DARK_DATAVIZ">
            <svg class="menu-item-icon" viewBox="0 0 24 24"><path d="M20 15.31V8.69L16.69 4H8.69L4 8.69v6.62L7.31 20h6.62L20 15.31zM12 18c-3.31 0-6-2.69-6-6s2.69-6 6-6 6 2.69 6 6-2.69 6-6 6z"/></svg>
            Dark
        </div>
    </div>

    <div class="menu-section">
        <div class="menu-section-title">Layers</div>
        <div class="menu-item" id="layer-radar" data-layer="Radar">
            <svg class="menu-item-icon" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 13h2v6h-2zm0-8h2v6h-2z"/></svg>
            Radar
        </div>
        <div class="menu-item" id="layer-cloud" data-layer="Cloud">
            <svg class="menu-item-icon" viewBox="0 0 24 24"><path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.86 8.32 1 10.59 1 13c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96z"/></svg>
            Clouds
        </div>
        <div class="menu-item" id="layer-wind" data-layer="Wind">
            <svg class="menu-item-icon" viewBox="0 0 24 24"><path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46A7.95 7.95 0 0020 12c0-4.42-3.58-8-8-8z"/></svg>
            Wind
        </div>
        <div class="menu-item" id="layer-temp" data-layer="Temp">
            <svg class="menu-item-icon" viewBox="0 0 24 24"><path d="M15 13V5c0-1.66-1.34-3-3-3S9 3.34 9 5v8c-1.21.91-2 2.37-2 4 0 2.76 2.24 5 5 5s5-2.24 5-5c0-1.63-.79-3.09-2-4zm-4-8c0-.55.45-1 1-1s1 .45 1 1h-2z"/></svg>
            Temp
        </div>
        <div class="menu-item" id="layer-himawari" data-layer="Himawari">
            <svg class="menu-item-icon" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/></svg>
            Himawari
        </div>
    </div>

    <div class="menu-section">
      <div class="menu-section-title">Controls</div>
      <div class="menu-item active" id="menu-track-toggle">
        <svg class="menu-item-icon" viewBox="0 0 24 24"><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg>
        Hide Track
      </div>
    </div>
</div>

<div id="info-panel" class="glass-panel">
  <h3>TY UWAN (FUNG-WONG)</h3>
  <div class="issued-text">JTWC WARNING NR 027</div>
  <div class="issued-text">ISSUED: <span>101800Z</span></div>
</div>

<div id="legend-container-icons" class="glass-panel">
    <div style="font-size:11px; font-weight:800; margin-bottom:8px; color:var(--text-main); font-family:var(--font-display);">TRACK KEY</div>
    <div id="legend-icons"></div>
</div>

<div id="legend-container-weather" class="glass-panel">
    <div id="weather-legend-content"></div>
</div>

<div id="animation-controls" class="glass-panel">
    <button class="anim-btn" id="anim-prev"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="19 20 9 12 19 4 19 20"></polygon><line x1="5" y1="19" x2="5" y2="5"></line></svg></button>
    <button class="anim-btn play-pause" id="anim-play-pause"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="none"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg></button>
    <button class="anim-btn" id="anim-next"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 4 15 12 5 20 5 4"></polygon><line x1="19" y1="5" x2="19" y2="19"></line></svg></button>
    <div id="animation-time">-- : --</div>
</div>

<script>
// --- CONFIGURATION ---
maptilersdk.config.apiKey = "oBs59fy19AM2IhfJXOvI";

// --- GLOBAL VARIABLES ---
const map = new maptilersdk.Map({
  container: "map",
  // CHANGED: Default to streets for light mode
  style: maptilersdk.MapStyle.STREETS, 
  center: [122.0, 20.5], 
  zoom: 5.5,
  hash: true,
  attributionControl: false
});

let radarLayer = null; 
let cloudLayer = null; 
let windLayer = null; 
let tempLayer = null; 
let himawariLayer = null; 
let activeWeatherLayerRef = null; 
let trackVisible = true; 
let popup; 
let isAnimating = false;
let animationInterval = null;
let animationTimeSpan = document.getElementById('animation-time');
let playPauseButton = document.getElementById('anim-play-pause');

// --- UTILITY ---
function convertDate(isoString) {
    const date = new Date(isoString);
    return date.toLocaleString('en-US', { 
        year: 'numeric', month: 'short', day: 'numeric', 
        hour: '2-digit', minute: '2-digit', hour12: false, timeZone: 'UTC' 
    }) + " UTC";
}

function getGIBSDate(offsetDays = 0) {
    const date = new Date();
    date.setUTCDate(date.getUTCDate() + offsetDays); 
    const year = date.getUTCFullYear();
    const month = String(date.getUTCMonth() + 1).padStart(2, '0');
    const day = String(date.getUTCDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

// --- ICON SVG GENERATOR ---
function createIconSVG(type, size = 32) {
  const blue = '#2563eb'; // Updated blue
  const red = '#ef4444'; 
  const white = '#ffffff';
  let color = blue;
  let innerShape = '';

  if (type === 'CURRENT') { color = red; }

  // Shape Logic
  if (type === 'CURRENT' || type === 'T') {
      // Typhoon Symbol (Pin with gap)
      innerShape = `<circle cx="16" cy="16" r="6" fill="${white}"/>`;
  } else if (type === 'S') {
      // Storm (Circle)
      innerShape = `<circle cx="16" cy="16" r="8" stroke="${white}" stroke-width="3" fill="none"/>`;
  } else if (type === 'L') {
      // Low (L)
      innerShape = `<text x="16" y="21" font-family="Arial" font-weight="bold" font-size="14" fill="${white}" text-anchor="middle">L</text>`;
  } else {
      innerShape = `<circle cx="16" cy="16" r="4" fill="${white}"/>`;
  }

  return `
    <svg width="${size}" height="${size}" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
      <circle cx="16" cy="16" r="14" fill="${color}" stroke="#000" stroke-width="2" fill-opacity="0.9"/>
      ${innerShape}
    </svg>
  `;
}

// --- TRACK DATA (UWAN) ---
const trackGeoJSON = {
  "type": "FeatureCollection",
  "features": [
    { "type": "Feature", "geometry": { "type": "Point", "coordinates": [119.5, 17.0] }, "properties": { "time": "2025-11-10T12:00Z", "wind_kt": 70, "label": "Past", "stage": "PAST", "icon_name": "tc-icon-PAST", "category": "Typhoon" }},
    { "type": "Feature", "geometry": { "type": "Point", "coordinates": [118.3, 18.8] }, "properties": { "time": "2025-11-10T18:00Z", "wind_kt": 65, "label": "Current", "stage": "CURRENT", "icon_name": "tc-icon-CURRENT", "category": "Typhoon" }},
    { "type": "Feature", "geometry": { "type": "Point", "coordinates": [118.3, 20.0] }, "properties": { "time": "2025-11-11T06:00Z", "wind_kt": 60, "label": "+12h", "stage": "T", "icon_name": "tc-icon-T", "category": "STS" }},
    { "type": "Feature", "geometry": { "type": "Point", "coordinates": [118.6, 21.1] }, "properties": { "time": "2025-11-11T18:00Z", "wind_kt": 55, "label": "+24h", "stage": "S", "icon_name": "tc-icon-S", "category": "STS" }},
    { "type": "Feature", "geometry": { "type": "Point", "coordinates": [119.5, 22.3] }, "properties": { "time": "2025-11-12T06:00Z", "wind_kt": 50, "label": "+36h", "stage": "S", "icon_name": "tc-icon-S", "category": "STS" }},
    { "type": "Feature", "geometry": { "type": "Point", "coordinates": [121.1, 23.6] }, "properties": { "time": "2025-11-12T18:00Z", "wind_kt": 35, "label": "+48h", "stage": "S", "icon_name": "tc-icon-S", "category": "TS" }},
    { "type": "Feature", "geometry": { "type": "Point", "coordinates": [124.6, 25.2] }, "properties": { "time": "2025-11-13T18:00Z", "wind_kt": 30, "label": "+72h", "stage": "L", "icon_name": "tc-icon-L", "category": "TD" }},
  ]
};

// --- TRACK LAYERS ---
function addTrackLayers(){
  if (trackVisible) return; 
  const coords = trackGeoJSON.features.map(f => f.geometry.coordinates);
  
  // Track Line
  map.addSource('track-line-src', { type: 'geojson', data: turf.lineString(coords) });
  map.addLayer({ 
      id: 'track-line', type: 'line', source: 'track-line-src', 
      paint: {
        'line-color': ['case', ['<=', ['line-progress'], 0.2], '#fbbf24', '#ef4444'], // Yellow to Red
        'line-width': 4,
        'line-dasharray': ['case', ['<=', ['line-progress'], 0.2], ['literal', [1, 0]], ['literal', [2, 1.5]]]
      }
  });

  // Track Points
  map.addSource('track-points-src', { type: 'geojson', data: trackGeoJSON });
  map.addLayer({
    id: 'track-points-layer', type: 'symbol', source: 'track-points-src', interactive: true, 
    layout: {
      'icon-image': ['get', 'icon_name'], 'icon-size': 0.8, 'icon-allow-overlap': true,
      'text-field': ['get', 'label'], 'text-font': ['Noto Sans Bold'], 'text-size': 12,
      'text-offset': [0, 1.8], 'text-anchor': 'top', 'text-allow-overlap': false
    },
    paint: { 
        'text-color': '#111827', // Dark text for white map
        'text-halo-color': '#ffffff', 
        'text-halo-width': 3 
    }
  });

  const bounds = coords.reduce((b, c) => b.extend(c), new maptilersdk.LngLatBounds(coords[0], coords[0]));
  map.fitBounds(bounds, { padding: 100, duration: 1000 });
  trackVisible = true;
  document.getElementById('menu-track-toggle').innerHTML = `<svg class="menu-item-icon" viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg> Hide Track`;
}

function removeTrackLayers(){
  if (!trackVisible) return;
  ['track-line', 'track-points-layer'].forEach(id => { if (map.getLayer(id)) map.removeLayer(id); });
  ['track-line-src', 'track-points-src'].forEach(id => { if (map.getSource(id)) map.removeSource(id); });
  if (popup) popup.remove();
  trackVisible = false;
  document.getElementById('menu-track-toggle').innerHTML = `<svg class="menu-item-icon" viewBox="0 0 24 24"><path d="M12 7c2.76 0 5 2.24 5 5 0 .65-.13 1.26-.36 1.83l2.92 2.92c1.51-1.26 2.7-2.89 3.43-4.75-1.73-4.39-6-7.5-11-7.5-1.4 0-2.74.25-3.98.7l2.16 2.16C10.74 7.13 11.35 7 12 7zM2 4.27l2.28 2.28.46.46A11.804 11.804 0 001 12c1.73 4.39 6 7.5 11 7.5 1.55 0 3.03-.3 4.38-.84l.42.42L19.73 22 21 20.73 3.27 3 2 4.27zM7.53 9.8l1.55 1.55c-.05.21-.08.43-.08.65 0 1.66 1.34 3 3 3 .22 0 .44-.03.65-.08l1.55 1.55c-.67.33-1.41.53-2.2.53-2.76 0-5-2.24-5-5 0-.79.2-1.53.53-2.2zm4.31-.78l3.15 3.15.02-.16c0-1.66-1.34-3-3-3l-.17.01z"/></svg> Show Track`;
}

// --- POPUP ---
function addPopupHandler() {
    popup = new maptilersdk.Popup({ closeButton: true, closeOnClick: true, maxWidth: '240px' });
    map.on('click', 'track-points-layer', (e) => {
        const props = e.features[0].properties;
        const coords = e.features[0].geometry.coordinates;
        popup.setLngLat(coords)
            .setHTML(`<div class="popup-title">TY UWAN (${props.category})</div>
                      <div class="popup-line"><strong>Time:</strong> ${convertDate(props.time)}</div>
                      <div class="popup-line"><strong>Wind:</strong> ${props.wind_kt} kts</div>`)
            .addTo(map);
    });
    map.on('mouseenter', 'track-points-layer', () => map.getCanvas().style.cursor = 'pointer');
    map.on('mouseleave', 'track-points-layer', () => map.getCanvas().style.cursor = '');
}

// --- LEGENDS ---
function populateLegend() {
    const iconTypes = [
        { type: 'CURRENT', label: 'Current Position' },
        { type: 'T', label: 'Typhoon' },             
        { type: 'S', label: 'Tropical Storm' },           
        { type: 'L', label: 'Low / Dissipated' }              
    ];
    const legendDiv = document.getElementById('legend-icons');
    iconTypes.forEach(item => {
        const svgString = createIconSVG(item.type, 18); 
        const div = document.createElement('div');
        div.className = 'legend-row';
        div.innerHTML = `<span>${svgString}</span> ${item.label}`;
        legendDiv.appendChild(div);
    });
}

function updateWeatherLegend(layerType) {
    const container = document.getElementById('legend-container-weather');
    const content = document.getElementById('weather-legend-content');
    
    if (!layerType) { container.style.display = 'none'; return; }

    let gradient = '', labels = '', title = '';
    if (layerType === 'Radar') {
        title = 'Radar (dBZ)';
        gradient = 'linear-gradient(90deg, #00cdff, #00ff00, #ffff00, #ff0000, #ff00ff)';
        labels = '<span>Light</span><span>Heavy</span>';
    } else if (layerType === 'Cloud') {
        title = 'Cloud Temp';
        gradient = 'linear-gradient(90deg, #ffffff, #808080, #000000)';
        labels = '<span>Warm</span><span>Cold</span>';
    } else if (layerType === 'Wind') {
        title = 'Wind Speed';
        gradient = 'linear-gradient(90deg, #444, #00f, #f0f, #f00)';
        labels = '<span>Calm</span><span>Strong</span>';
    } else if (layerType === 'Temp') {
        title = 'Temperature';
        gradient = 'linear-gradient(90deg, #00f, #0ff, #ff0, #f00)';
        labels = '<span>Cold</span><span>Hot</span>';
    } else if (layerType === 'Himawari') {
        title = 'Satellite IR';
        gradient = 'linear-gradient(90deg, #fff, #000)';
        labels = '<span>Cloud</span><span>Clear</span>';
    }

    content.innerHTML = `<div class="legend-title">${title}</div><div class="legend-bar" style="background:${gradient}"></div><div class="legend-labels">${labels}</div>`;
    container.style.display = 'block';
}

// --- LAYER LOGIC ---
function clearWeatherLayers(keep = null){
    stopAnimation();
    const refs = [radarLayer, cloudLayer, windLayer, tempLayer, himawariLayer];
    refs.forEach(layer => {
        if(layer && layer !== keep && map.getLayer(layer.id)) map.removeLayer(layer.id);
        if(layer && layer.id === 'himawari-layer' && map.getSource('himawari-src')) map.removeSource('himawari-src');
    });
    radarLayer = cloudLayer = windLayer = tempLayer = himawariLayer = null;
    activeWeatherLayerRef = null;
    document.querySelectorAll('#menu-panel [data-layer]').forEach(b => b.classList.remove('active'));
    
    if (keep) {
        activeWeatherLayerRef = keep;
        if(keep.id.includes('radar')) radarLayer = keep;
        if(keep.id.includes('cloud')) cloudLayer = keep;
        if(keep.id.includes('wind')) windLayer = keep;
        if(keep.id.includes('temp')) tempLayer = keep;
        if(keep.id.includes('himawari')) himawariLayer = keep;
    } else {
        updateWeatherLegend(null);
    }
}

function toggleLayer(currentRef, constructor, layerType, id, colorramp = null) {
    if (currentRef) { clearWeatherLayers(); return null; }
    
    clearWeatherLayers();
    const options = { opacity: 0.8, id: id };
    if (colorramp) options.colorramp = colorramp;
    
    const newLayer = new constructor(options);
    map.addLayer(newLayer, 'track-line'); 
    
    document.getElementById('layer-' + layerType.toLowerCase()).classList.add("active");
    updateWeatherLegend(layerType);
    activeWeatherLayerRef = newLayer;
    return newLayer;
}

// --- EVENT HANDLERS ---
document.getElementById("layer-radar").onclick = () => radarLayer = toggleLayer(radarLayer, maptilerweather.RadarLayer, 'Radar', 'radar-layer');
document.getElementById("layer-cloud").onclick = () => cloudLayer = toggleLayer(cloudLayer, maptilerweather.RadarLayer, 'Cloud', 'cloud-layer', maptilerweather.ColorRamp.builtin.RADAR_CLOUD);
document.getElementById("layer-wind").onclick = () => windLayer = toggleLayer(windLayer, maptilerweather.WindLayer, 'Wind', 'wind-layer');
document.getElementById("layer-temp").onclick = () => tempLayer = toggleLayer(tempLayer, maptilerweather.TemperatureLayer, 'Temp', 'temp-layer');

document.getElementById("layer-himawari").onclick = () => {
    if (himawariLayer) { clearWeatherLayers(); return; }
    clearWeatherLayers();
    handleHimawariToggle();
};

function handleHimawariToggle(attempt = 0) {
    if (attempt > 1) { alert("Himawari data unavailable for today."); return; }
    const dateToUse = getGIBSDate(attempt === 0 ? 0 : -1);
    const tileURL = `https://gibs.earthdata.nasa.gov/wmts/epsg3857/best/Himawari_AHI_Band13_Clean_Infrared/default/${dateToUse}/GoogleMapsCompatible_Level6/{z}/{y}/{x}.png`;

    try {
        map.addSource('himawari-src', { type: 'raster', tiles: [tileURL], tileSize: 256 });
        himawariLayer = { id: 'himawari-layer' };
        map.addLayer({ id: 'himawari-layer', type: 'raster', source: 'himawari-src', paint: { 'raster-opacity': 0.6 } }, 'track-line');
        document.getElementById("layer-himawari").classList.add("active");
        updateWeatherLegend('Himawari');
        activeWeatherLayerRef = himawariLayer;
    } catch(e) {
        handleHimawariToggle(attempt + 1);
    }
}

// --- ANIMATION ---
function startAnimation() {
    if (isAnimating || !activeWeatherLayerRef || !activeWeatherLayerRef.animateByFactor) return;
    isAnimating = true;
    playPauseButton.innerHTML = `<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="none"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg>`;
    
    activeWeatherLayerRef.animateByFactor(3600);
    animationInterval = setInterval(() => {
        const time = new Date(activeWeatherLayerRef.getTime());
        animationTimeSpan.textContent = time.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) + " UTC";
    }, 100);
}

function stopAnimation() {
    isAnimating = false;
    playPauseButton.innerHTML = `<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="none"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>`;
    if (animationInterval) clearInterval(animationInterval);
    if (activeWeatherLayerRef && activeWeatherLayerRef.stopAnimation) activeWeatherLayerRef.stopAnimation();
}

playPauseButton.onclick = () => isAnimating ? stopAnimation() : startAnimation();
document.getElementById("menu-track-toggle").onclick = () => trackVisible ? removeTrackLayers() : addTrackLayers();

// --- MAP STYLES ---
document.querySelectorAll('#menu-panel [data-style]').forEach(btn => {
    btn.addEventListener('click', (e) => {
        const styleName = e.currentTarget.getAttribute('data-style');
        let newStyle = maptilersdk.MapStyle.STREETS;
        if(styleName === 'DARK_DATAVIZ') newStyle = maptilersdk.MapStyle.DATAVIZ.DARK;
        if(styleName === 'SATELLITE') newStyle = maptilersdk.MapStyle.SATELLITE;
        
        stopAnimation();
        map.setStyle(newStyle);
        
        document.querySelectorAll('#menu-panel [data-style]').forEach(b => b.classList.remove('active'));
        e.currentTarget.classList.add('active');
        
        map.once('style.load', () => {
            if (trackVisible) { removeTrackLayers(); addTrackLayers(); }
            clearWeatherLayers(); 
        });
    });
});

// --- INIT ---
async function loadAllIcons() {
    const iconTypes = [{t:'PAST',n:'tc-icon-PAST'},{t:'CURRENT',n:'tc-icon-CURRENT'},{t:'T',n:'tc-icon-T'},{t:'S',n:'tc-icon-S'},{t:'L',n:'tc-icon-L'}];
    for (const icon of iconTypes) {
        const img = new Image(32, 32);
        img.src = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(createIconSVG(icon.t, 32));
        await new Promise(r => img.onload = r);
        if (!map.hasImage(icon.n)) map.addImage(icon.n, img);
    }
}

map.on("load", async ()=>{
    await loadAllIcons();
    trackVisible = false; // Reset flag for logic
    addTrackLayers();
    populateLegend();
    
    // Auto-load Radar
    radarLayer = new maptilerweather.RadarLayer({opacity:0.6, id: 'radar-layer'});
    map.addLayer(radarLayer, 'track-line');
    document.getElementById("layer-radar").classList.add("active");
    activeWeatherLayerRef = radarLayer;
    updateWeatherLegend('Radar');
    
    addPopupHandler();
});
</script>
</body>
</html>
